{"ast":null,"code":"var _jsxFileName = \"C:\\\\Users\\\\Hari\\\\OneDrive\\\\Desktop\\\\elevator_project\\\\frontend\\\\src\\\\ChatBox.js\",\n  _s = $RefreshSig$();\nimport React, { useEffect, useRef, useState } from \"react\";\nimport axios from \"axios\";\nimport ChatMessage from \"./ChatMessage\";\n\n// --- CONFIGURATION ---\nimport { jsxDEV as _jsxDEV, Fragment as _Fragment } from \"react/jsx-dev-runtime\";\nconst BACKEND_URL = \"http://localhost:8001\"; // Technician/Chat Service\n// ---\n\n// Component now expects 'expertId' to be passed from the parent component (Technician ID)\nexport default function ChatBox({\n  initialLog,\n  onNewLog,\n  expertId\n}) {\n  _s();\n  const [messages, setMessages] = useState([]);\n  const [input, setInput] = useState(\"\");\n  const [isLoading, setIsLoading] = useState(false);\n  const messagesRef = useRef(null);\n\n  // Load initial log content when selected from the side panel\n  useEffect(() => {\n    if (initialLog) {\n      const queryText = initialLog.user_query;\n      const responseText = initialLog.ai_response;\n      // Convert single response string back into steps array for display\n      const steps = responseText.split('\\n').filter(Boolean);\n      const queryMessage = {\n        role: \"user\",\n        text: queryText\n      };\n      const aiResponseMessage = {\n        role: \"ai\",\n        text: responseText,\n        steps: steps\n      };\n      setMessages([queryMessage, aiResponseMessage]);\n    } else {\n      setMessages([]);\n    }\n  }, [initialLog]);\n\n  // Scroll to the bottom on new messages\n  useEffect(() => {\n    if (messagesRef.current) {\n      messagesRef.current.scrollTop = messagesRef.current.scrollHeight;\n    }\n  }, [messages]);\n\n  // FUNCTION TO SAVE MESSAGE TO DATABASE\n  async function persistLog(userQuery, aiResponseText) {\n    if (!expertId) return;\n    try {\n      const logId = crypto.randomUUID();\n\n      // Data structure matching the assumed backend schema\n      const logData = {\n        expert_id: expertId,\n        // Dynamic ID of the logged-in technician\n        user_query: userQuery,\n        ai_response: aiResponseText,\n        // Must be a single string for backend\n        status: \"completed\",\n        timestamp: new Date().toISOString(),\n        log_id: logId\n      };\n\n      // POST to the FastAPI endpoint to store the chat log\n      const res = await axios.post(`${BACKEND_URL}/api/store_log`, logData);\n\n      // Notify ChatPage to refresh its list\n      if (onNewLog && res.status === 200) {\n        onNewLog();\n      }\n    } catch (err) {\n      console.error(\"Error saving log:\", err.response ? err.response.data : err.message);\n    }\n  }\n  async function sendQuery(e) {\n    e.preventDefault();\n    if (!input.trim() || isLoading || !expertId) return;\n    const userQuery = input.trim();\n    setMessages(prev => [...prev, {\n      role: \"user\",\n      text: userQuery\n    }]);\n    setInput(\"\");\n    setIsLoading(true);\n    const steps = generateDemoSteps(userQuery);\n    const aiResponseText = steps.join(\"\\n\");\n    setTimeout(async () => {\n      setIsLoading(false);\n      setMessages(prev => {\n        const aiMessage = {\n          role: \"ai\",\n          text: aiResponseText,\n          steps\n        };\n        // CRITICAL: CALL PERSISTENCE FUNCTION HERE\n        persistLog(userQuery, aiResponseText);\n        return [...prev, aiMessage];\n      });\n    }, 700);\n  }\n  function generateDemoSteps(q) {\n    if (/door/i.test(q)) return [\"Step 1: Check door tracks and clear any obstruction.\", \"Step 2: Lubricate the guides and test door motor.\", \"Step 3: Inspect limit switches and sensors.\"];\n    if (/sensor/i.test(q)) return [\"Step 1: Power off and inspect sensor connectors.\", \"Step 2: Clean the sensor lens.\", \"Step 3: Replace the sensor if readings are inconsistent.\"];\n    return [\"Step 1: Check wiring and power supply.\", \"Step 2: Verify control board connections.\", \"Step 3: Test the motor relay.\"];\n  }\n  const isInputDisabled = isLoading || !expertId;\n  return /*#__PURE__*/_jsxDEV(_Fragment, {\n    children: [/*#__PURE__*/_jsxDEV(\"div\", {\n      className: \"messages\",\n      ref: messagesRef,\n      children: [messages.map((m, i) => /*#__PURE__*/_jsxDEV(ChatMessage, {\n        message: m\n      }, i, false, {\n        fileName: _jsxFileName,\n        lineNumber: 124,\n        columnNumber: 11\n      }, this)), isLoading && /*#__PURE__*/_jsxDEV(\"div\", {\n        className: \"message ai-message\",\n        children: \"Thinking...\"\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 127,\n        columnNumber: 11\n      }, this)]\n    }, void 0, true, {\n      fileName: _jsxFileName,\n      lineNumber: 122,\n      columnNumber: 7\n    }, this), /*#__PURE__*/_jsxDEV(\"form\", {\n      className: \"chat-input\",\n      onSubmit: sendQuery,\n      children: [/*#__PURE__*/_jsxDEV(\"input\", {\n        type: \"text\",\n        placeholder: expertId ? \"Type your query...\" : \"Please log in to start chatting.\",\n        value: input,\n        onChange: e => setInput(e.target.value),\n        disabled: isInputDisabled\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 134,\n        columnNumber: 9\n      }, this), /*#__PURE__*/_jsxDEV(\"button\", {\n        className: \"btn\",\n        type: \"submit\",\n        disabled: isInputDisabled,\n        children: \"Send\"\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 141,\n        columnNumber: 9\n      }, this)]\n    }, void 0, true, {\n      fileName: _jsxFileName,\n      lineNumber: 133,\n      columnNumber: 7\n    }, this)]\n  }, void 0, true);\n}\n_s(ChatBox, \"sF2KxnQY79ZJMfoxSEP+NqdH85o=\");\n_c = ChatBox;\nvar _c;\n$RefreshReg$(_c, \"ChatBox\");","map":{"version":3,"names":["React","useEffect","useRef","useState","axios","ChatMessage","jsxDEV","_jsxDEV","Fragment","_Fragment","BACKEND_URL","ChatBox","initialLog","onNewLog","expertId","_s","messages","setMessages","input","setInput","isLoading","setIsLoading","messagesRef","queryText","user_query","responseText","ai_response","steps","split","filter","Boolean","queryMessage","role","text","aiResponseMessage","current","scrollTop","scrollHeight","persistLog","userQuery","aiResponseText","logId","crypto","randomUUID","logData","expert_id","status","timestamp","Date","toISOString","log_id","res","post","err","console","error","response","data","message","sendQuery","e","preventDefault","trim","prev","generateDemoSteps","join","setTimeout","aiMessage","q","test","isInputDisabled","children","className","ref","map","m","i","fileName","_jsxFileName","lineNumber","columnNumber","onSubmit","type","placeholder","value","onChange","target","disabled","_c","$RefreshReg$"],"sources":["C:/Users/Hari/OneDrive/Desktop/elevator_project/frontend/src/ChatBox.js"],"sourcesContent":["import React, { useEffect, useRef, useState } from \"react\";\r\nimport axios from \"axios\";\r\nimport ChatMessage from \"./ChatMessage\";\r\n\r\n// --- CONFIGURATION ---\r\nconst BACKEND_URL = \"http://localhost:8001\"; // Technician/Chat Service\r\n// ---\r\n\r\n// Component now expects 'expertId' to be passed from the parent component (Technician ID)\r\nexport default function ChatBox({ initialLog, onNewLog, expertId }) {\r\n  const [messages, setMessages] = useState([]);\r\n  const [input, setInput] = useState(\"\");\r\n  const [isLoading, setIsLoading] = useState(false);\r\n  const messagesRef = useRef(null);\r\n\r\n  // Load initial log content when selected from the side panel\r\n  useEffect(() => {\r\n    if (initialLog) {\r\n      const queryText = initialLog.user_query;\r\n      const responseText = initialLog.ai_response;\r\n      // Convert single response string back into steps array for display\r\n      const steps = responseText.split('\\n').filter(Boolean); \r\n\r\n      const queryMessage = { role: \"user\", text: queryText };\r\n      const aiResponseMessage = { \r\n        role: \"ai\", \r\n        text: responseText, \r\n        steps: steps \r\n      };\r\n      setMessages([queryMessage, aiResponseMessage]);\r\n    } else {\r\n      setMessages([]);\r\n    }\r\n  }, [initialLog]);\r\n\r\n  // Scroll to the bottom on new messages\r\n  useEffect(() => {\r\n    if (messagesRef.current) {\r\n      messagesRef.current.scrollTop = messagesRef.current.scrollHeight;\r\n    }\r\n  }, [messages]);\r\n\r\n\r\n  // FUNCTION TO SAVE MESSAGE TO DATABASE\r\n  async function persistLog(userQuery, aiResponseText) {\r\n    if (!expertId) return; \r\n\r\n    try {\r\n      const logId = crypto.randomUUID(); \r\n\r\n      // Data structure matching the assumed backend schema\r\n      const logData = {\r\n        expert_id: expertId, // Dynamic ID of the logged-in technician\r\n        user_query: userQuery,      \r\n        ai_response: aiResponseText, // Must be a single string for backend\r\n        status: \"completed\",        \r\n        timestamp: new Date().toISOString(), \r\n        log_id: logId,              \r\n      };\r\n      \r\n      // POST to the FastAPI endpoint to store the chat log\r\n      const res = await axios.post(`${BACKEND_URL}/api/store_log`, logData);\r\n      \r\n      // Notify ChatPage to refresh its list\r\n      if (onNewLog && res.status === 200) {\r\n          onNewLog();\r\n      }\r\n\r\n    } catch (err) {\r\n      console.error(\"Error saving log:\", err.response ? err.response.data : err.message);\r\n    }\r\n  }\r\n\r\n  async function sendQuery(e) {\r\n    e.preventDefault();\r\n    if (!input.trim() || isLoading || !expertId) return;\r\n\r\n    const userQuery = input.trim();\r\n    setMessages((prev) => [...prev, { role: \"user\", text: userQuery }]);\r\n    setInput(\"\");\r\n    setIsLoading(true);\r\n\r\n    const steps = generateDemoSteps(userQuery);\r\n    const aiResponseText = steps.join(\"\\n\"); \r\n    \r\n    setTimeout(async () => {\r\n      setIsLoading(false);\r\n        \r\n      setMessages((prev) => {\r\n        const aiMessage = { role: \"ai\", text: aiResponseText, steps };\r\n        // CRITICAL: CALL PERSISTENCE FUNCTION HERE\r\n        persistLog(userQuery, aiResponseText); \r\n        return [...prev, aiMessage];\r\n      });\r\n    }, 700);\r\n  }\r\n  \r\n  function generateDemoSteps(q) {\r\n    if (/door/i.test(q))\r\n      return [\r\n        \"Step 1: Check door tracks and clear any obstruction.\",\r\n        \"Step 2: Lubricate the guides and test door motor.\",\r\n        \"Step 3: Inspect limit switches and sensors.\",\r\n      ];\r\n    if (/sensor/i.test(q))\r\n      return [\r\n        \"Step 1: Power off and inspect sensor connectors.\",\r\n        \"Step 2: Clean the sensor lens.\",\r\n        \"Step 3: Replace the sensor if readings are inconsistent.\",\r\n      ];\r\n    return [\r\n      \"Step 1: Check wiring and power supply.\",\r\n      \"Step 2: Verify control board connections.\",\r\n      \"Step 3: Test the motor relay.\",\r\n    ];\r\n  }\r\n\r\n  const isInputDisabled = isLoading || !expertId;\r\n\r\n  return (\r\n    <>\r\n      <div className=\"messages\" ref={messagesRef}>\r\n        {messages.map((m, i) => (\r\n          <ChatMessage key={i} message={m} />\r\n        ))}\r\n        {isLoading && (\r\n          <div className=\"message ai-message\">\r\n            Thinking...\r\n          </div>\r\n        )}\r\n      </div>\r\n\r\n      <form className=\"chat-input\" onSubmit={sendQuery}>\r\n        <input\r\n          type=\"text\"\r\n          placeholder={expertId ? \"Type your query...\" : \"Please log in to start chatting.\"}\r\n          value={input}\r\n          onChange={(e) => setInput(e.target.value)}\r\n          disabled={isInputDisabled}\r\n        />\r\n        <button className=\"btn\" type=\"submit\" disabled={isInputDisabled}>\r\n          Send\r\n        </button>\r\n      </form>\r\n    </>\r\n );\r\n}"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}