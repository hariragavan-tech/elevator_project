{"ast":null,"code":"import axios from \"axios\";\n\n// --- CONFIGURATION ---\nconst BACKEND_URL = \"http://localhost:8001\";\nconst GEMINI_API_KEY = \"\"; // Leave empty, Canvas provides it at runtime\nconst GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${GEMINI_API_KEY}`;\n// ---\n\n/**\r\n * Handles fetch requests with exponential backoff for transient errors.\r\n */\nexport const fetchWithBackoff = async (url, options, maxRetries = 5) => {\n  for (let attempt = 0; attempt < maxRetries; attempt++) {\n    try {\n      const response = await fetch(url, options);\n      if (!response.ok) {\n        throw new Error(`HTTP error! status: ${response.status}`);\n      }\n      return response;\n    } catch (error) {\n      console.error(`Attempt ${attempt + 1} failed: ${error.message}`);\n      if (attempt === maxRetries - 1) throw error;\n      const delay = Math.pow(2, attempt) * 1000;\n      await new Promise(resolve => setTimeout(resolve, delay));\n    }\n  }\n};\n\n/**\r\n * RAG Implementation: Fetches relevant expert knowledge from the backend vector store.\r\n */\nexport const fetchKnowledge = async query => {\n  try {\n    var _res$data;\n    const res = await axios.get(`${BACKEND_URL}/knowledge_search?query=${encodeURIComponent(query)}&n_results=3`);\n    const relevantDocs = ((_res$data = res.data) === null || _res$data === void 0 ? void 0 : _res$data.results) || [];\n    if (relevantDocs.length > 0) {\n      console.log(`ðŸ” Found ${relevantDocs.length} knowledge items for RAG.`);\n      return relevantDocs.map((doc, index) => `Context ${index + 1}: ${doc}`).join(\"\\n---\\n\");\n    }\n    return null;\n  } catch (error) {\n    console.error(\"âŒ Error fetching knowledge for RAG:\", error);\n    return null;\n  }\n};\n\n/**\r\n * Calls the Gemini API, optionally grounding the response with RAG context.\r\n */\nexport const getGeminiResponse = async userQuery => {\n  const knowledgeContext = await fetchKnowledge(userQuery);\n  let systemPrompt = \"You are a helpful and detailed technical support expert. Provide concise, step-by-step solutions to the user's query. Your entire response must be a series of steps, each on a new line (e.g., 'Step 1: check power', 'Step 2: replace part').\";\n  if (knowledgeContext) {\n    systemPrompt += `\\n\\n--- CRITICAL KNOWLEDGE BASE CONTEXT ---\\n${knowledgeContext}\\n--- END OF CONTEXT---\\n\n        \\nPrioritize the solution steps based on the provided expert knowledge context if it directly addresses the user's current query. If no context is relevant, use your general technical knowledge.`;\n  }\n  const payload = {\n    contents: [{\n      role: \"user\",\n      parts: [{\n        text: userQuery\n      }]\n    }],\n    systemInstruction: {\n      parts: [{\n        text: systemPrompt\n      }]\n    }\n  };\n  try {\n    var _result$candidates, _result$candidates$, _result$candidates$$c, _result$candidates$$c2, _result$candidates$$c3;\n    const response = await fetchWithBackoff(GEMINI_API_URL, {\n      method: 'POST',\n      headers: {\n        'Content-Type': 'application/json'\n      },\n      body: JSON.stringify(payload)\n    });\n    const result = await response.json();\n    const text = (result === null || result === void 0 ? void 0 : (_result$candidates = result.candidates) === null || _result$candidates === void 0 ? void 0 : (_result$candidates$ = _result$candidates[0]) === null || _result$candidates$ === void 0 ? void 0 : (_result$candidates$$c = _result$candidates$.content) === null || _result$candidates$$c === void 0 ? void 0 : (_result$candidates$$c2 = _result$candidates$$c.parts) === null || _result$candidates$$c2 === void 0 ? void 0 : (_result$candidates$$c3 = _result$candidates$$c2[0]) === null || _result$candidates$$c3 === void 0 ? void 0 : _result$candidates$$c3.text) || \"Sorry, I couldn't generate a response. Please check the system status.\";\n    return text;\n  } catch (error) {\n    console.error(\"Gemini API call failed:\", error);\n    return \"The AI service is currently unavailable.\";\n  }\n};\n\n/**\r\n * Stores the chat log entry in the backend database.\r\n */\nexport async function persistLog(expertId, userQuery, aiResponseText) {\n  if (!expertId) return;\n  try {\n    const logId = crypto.randomUUID();\n    const logData = {\n      expert_id: expertId,\n      user_query: userQuery,\n      ai_response: aiResponseText,\n      // Must be a single string\n      status: \"completed\",\n      timestamp: new Date().toISOString(),\n      log_id: logId\n    };\n    await axios.post(`${BACKEND_URL}/api/store_log`, logData);\n    return true;\n  } catch (err) {\n    console.error(\"Error saving log:\", err.response ? err.response.data : err.message);\n    return false;\n  }\n}","map":{"version":3,"names":["axios","BACKEND_URL","GEMINI_API_KEY","GEMINI_API_URL","fetchWithBackoff","url","options","maxRetries","attempt","response","fetch","ok","Error","status","error","console","message","delay","Math","pow","Promise","resolve","setTimeout","fetchKnowledge","query","_res$data","res","get","encodeURIComponent","relevantDocs","data","results","length","log","map","doc","index","join","getGeminiResponse","userQuery","knowledgeContext","systemPrompt","payload","contents","role","parts","text","systemInstruction","_result$candidates","_result$candidates$","_result$candidates$$c","_result$candidates$$c2","_result$candidates$$c3","method","headers","body","JSON","stringify","result","json","candidates","content","persistLog","expertId","aiResponseText","logId","crypto","randomUUID","logData","expert_id","user_query","ai_response","timestamp","Date","toISOString","log_id","post","err"],"sources":["C:/Users/Hari/OneDrive/Desktop/elevator_project/frontend/src/api.js"],"sourcesContent":["import axios from \"axios\";\r\n\r\n// --- CONFIGURATION ---\r\nconst BACKEND_URL = \"http://localhost:8001\"; \r\nconst GEMINI_API_KEY = \"\"; // Leave empty, Canvas provides it at runtime\r\nconst GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${GEMINI_API_KEY}`;\r\n// ---\r\n\r\n/**\r\n * Handles fetch requests with exponential backoff for transient errors.\r\n */\r\nexport const fetchWithBackoff = async (url, options, maxRetries = 5) => {\r\n    for (let attempt = 0; attempt < maxRetries; attempt++) {\r\n        try {\r\n            const response = await fetch(url, options);\r\n            if (!response.ok) {\r\n                throw new Error(`HTTP error! status: ${response.status}`);\r\n            }\r\n            return response;\r\n        } catch (error) {\r\n            console.error(`Attempt ${attempt + 1} failed: ${error.message}`);\r\n            if (attempt === maxRetries - 1) throw error; \r\n            const delay = Math.pow(2, attempt) * 1000;\r\n            await new Promise(resolve => setTimeout(resolve, delay));\r\n        }\r\n    }\r\n};\r\n\r\n/**\r\n * RAG Implementation: Fetches relevant expert knowledge from the backend vector store.\r\n */\r\nexport const fetchKnowledge = async (query) => {\r\n    try {\r\n        const res = await axios.get(`${BACKEND_URL}/knowledge_search?query=${encodeURIComponent(query)}&n_results=3`);\r\n        const relevantDocs = res.data?.results || [];\r\n        \r\n        if (relevantDocs.length > 0) {\r\n            console.log(`ðŸ” Found ${relevantDocs.length} knowledge items for RAG.`);\r\n            return relevantDocs.map((doc, index) => `Context ${index + 1}: ${doc}`).join(\"\\n---\\n\");\r\n        }\r\n        return null;\r\n    } catch (error) {\r\n        console.error(\"âŒ Error fetching knowledge for RAG:\", error);\r\n        return null;\r\n    }\r\n};\r\n\r\n/**\r\n * Calls the Gemini API, optionally grounding the response with RAG context.\r\n */\r\nexport const getGeminiResponse = async (userQuery) => {\r\n    const knowledgeContext = await fetchKnowledge(userQuery);\r\n    \r\n    let systemPrompt = \"You are a helpful and detailed technical support expert. Provide concise, step-by-step solutions to the user's query. Your entire response must be a series of steps, each on a new line (e.g., 'Step 1: check power', 'Step 2: replace part').\";\r\n    \r\n    if (knowledgeContext) {\r\n        systemPrompt += `\\n\\n--- CRITICAL KNOWLEDGE BASE CONTEXT ---\\n${knowledgeContext}\\n--- END OF CONTEXT---\\n\r\n        \\nPrioritize the solution steps based on the provided expert knowledge context if it directly addresses the user's current query. If no context is relevant, use your general technical knowledge.`;\r\n    }\r\n\r\n    const payload = {\r\n        contents: [\r\n            { role: \"user\", parts: [{ text: userQuery }] }\r\n        ],\r\n        systemInstruction: {\r\n            parts: [{ text: systemPrompt }]\r\n        },\r\n    };\r\n\r\n    try {\r\n        const response = await fetchWithBackoff(GEMINI_API_URL, {\r\n            method: 'POST',\r\n            headers: { 'Content-Type': 'application/json' },\r\n            body: JSON.stringify(payload)\r\n        });\r\n        \r\n        const result = await response.json();\r\n        const text = result?.candidates?.[0]?.content?.parts?.[0]?.text || \"Sorry, I couldn't generate a response. Please check the system status.\";\r\n        return text;\r\n\r\n    } catch (error) {\r\n        console.error(\"Gemini API call failed:\", error);\r\n        return \"The AI service is currently unavailable.\";\r\n    }\r\n};\r\n\r\n/**\r\n * Stores the chat log entry in the backend database.\r\n */\r\nexport async function persistLog(expertId, userQuery, aiResponseText) {\r\n    if (!expertId) return; \r\n    \r\n    try {\r\n        const logId = crypto.randomUUID(); \r\n        const logData = {\r\n            expert_id: expertId,\r\n            user_query: userQuery,\r\n            ai_response: aiResponseText, // Must be a single string\r\n            status: \"completed\",\r\n            timestamp: new Date().toISOString(),\r\n            log_id: logId,\r\n        };\r\n        \r\n        await axios.post(`${BACKEND_URL}/api/store_log`, logData);\r\n        return true;\r\n\r\n    } catch (err) {\r\n        console.error(\"Error saving log:\", err.response ? err.response.data : err.message);\r\n        return false;\r\n    }\r\n}"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}